<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blumaps</title>
  {% load static %}
  <link rel="icon" href="{% static 'icon8.png' %}" type="image/x-icon">

  <!-- Web3Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@latest/dist/web3auth.umd.min.js"></script>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Global Styles */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #002D62, #005BB5);
      color: #ffffff;
      position: relative;
    }
    /* Scrollbar Styles */
    ::-webkit-scrollbar { width: 16px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 8px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    html { scrollbar-width: auto; scrollbar-color: #888 #f1f1f1; }

    /* Navbar */
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #statusNav { margin-right: 1rem; }

    /* Map Container */
    #map {
      height: 900px;
      border: 3px solid #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      margin-bottom: 2rem;
    }

    /* Top Banner */
    .top-banner {
      background-color: #002D62;
      padding: 30px;
      text-align: center;
      width: 100%;
      margin-bottom: 20px;
      color: #ffffff;
    }
    .top-banner .professional-heading { font-size: 2.5rem; margin: 0; }
    .top-banner .lead { font-size: 1.25rem; margin-top: 10px; }

    /* Sidebar (Draggable) */
    .sidebar {
      position: fixed;
      top: 20%;
      left: 2%;
      width: 220px;
      background: rgba(0,0,0,0.75);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: move;
    }
    .sidebar h5 { font-size: 1.25rem; margin-bottom: 0.75rem; }
    .sidebar .btn { width: 100%; margin-bottom: 0.75rem; }

    /* Professional Buttons */
    .btn-professional {
      font-family: 'Roboto', sans-serif;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
    }
    .btn-professional.btn-add { background-color: #005BB5; color: #ffffff; }
    .btn-professional.btn-add:hover { background-color: #004a9e; }
    .btn-professional.btn-view { background-color: #003f7f; color: #ffffff; }
    .btn-professional.btn-view:hover { background-color: #003469; }

    /* About Section */
    #about-section {
      background: rgba(0,0,0,0.8);
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    /* Banner Section */
    .banner {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #002D62;
      padding: 20px;
      width: 100%;
      height: 120px;
    }
    .banner-logo {
      height: 50px;
      max-width: 60px;
      object-fit: contain;
      background-color: white;
      padding: 5px;
      border-radius: 4px;
      margin: 0 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #dataScienceSidebar {
      position: fixed;
      top: 20%;
      left: 2%;
      width: 250px;
      background: rgba(0,0,0,0.85);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: move;
      color: #ffffff;
      z-index: 1050;
    }

    /* Cookie Consent */
    .cookie-consent {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.85);
      color: #ffffff;
      padding: 1rem;
      text-align: center;
      z-index: 1100;
    }

    #tapMessage {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #ffffff;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1.2rem;
      z-index: 1500;
      display: none;
    }

    /* Auth Modal Dark Background */
    .modal-content.auth-modal-dark {
      background-color: #1a1a1a;
      color: #e0e0e0;
      border: none;
    }

    /* Scroll Buttons */
    .scroll-btn {
      position: fixed;
      right: 20px;
      z-index: 9999;
      font-size: 1.5rem;
      padding: 10px 15px;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      color: #fff;
      background-color: #005BB5;
    }
    #scrollUpBtn { bottom: 80px; }
    #scrollDownBtn { bottom: 20px; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#" id="brandName">Blumaps</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Explore
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="dataScienceBtn">Insights</a></li>
            <li><a class="dropdown-item" href="#about-section">About</a></li>
            <!-- New NFT Dropdown Item -->
            <li><a class="dropdown-item" href="/nft">NFT</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <span class="navbar-text d-none" id="statusNav">
            Community Builder: <span id="userStars">-</span>
          </span>
        </li>
        <!-- Log In Link -->
        <li class="nav-item">
          <a id="auth-link" class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#authModal">Log In</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


<!-- Draggable Data Science Sidebar -->
<div id="dataScienceSidebar" class="sidebar d-none">
  <div class="d-flex justify-content-between align-items-center">
    <h5>Insights</h5>
    <button class="btn-close btn-close-white" id="closeDataScience"></button>
  </div>
  <hr>
  <div id="dataScienceContent">
    <p>Loading insights...</p>
  </div>
</div>

<!-- Top Banner -->
<header class="top-banner">
  <h1 class="professional-heading"> *</h1>
  <h1 class="professional-heading">Blumaps</h1>
  <p class="lead">Mapping Needs & Ideas</p>
</header>

<!-- Authentication Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content auth-modal-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="authModalLabel" style="color: #bbb;">Only login via email, Google, or +86 phone number</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Login Form -->
        <form id="loginForm">
          <div class="mb-3">
            <input type="text" class="form-control" id="loginPhoneOrEmail" placeholder="Phone number or email address" required>
          </div>
          <div class="mb-3">
            <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="tosCheck" required>
            <label class="form-check-label" for="tosCheck">
              I confirm that I have read, consent and agree to Blumaps's Terms of Use and Privacy Policy.
            </label>
          </div>
          <button type="submit" class="btn btn-primary w-100">Log In</button>
        </form>
        <div class="d-flex justify-content-between mt-3">
          <a href="#" class="text-decoration-none" style="color: #aaa;">Forgot password?</a>
          <a href="#" class="text-decoration-none" style="color: #aaa;">Sign up</a>
        </div>
        <div class="text-center mt-3" style="color: #aaa;">OR</div>
        <!-- Log in with Google -->
        <button type="button" class="btn btn-light w-100 mt-2" id="googleLoginBtn">
          Log in with Google
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Adding Need Data -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-secondary" id="dataModalLabel">Add Need</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="locationForm">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" placeholder="Enter title" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" placeholder="Enter description" required></textarea>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Category Selected</label>
            <select class="form-select" id="category" required>
              <option value="Community">Community</option>
              <option value="Commerce">Commerce</option>
              <option value="Private">Private</option>
            </select>
          </div>
          <!-- Hidden Coordinates -->
          <input type="hidden" id="latitude">
          <input type="hidden" id="longitude">
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar for Desktop Controls (Draggable) -->
<div class="sidebar d-none d-lg-block">
  <div class="mb-4">
    <h5>Add</h5>
    <button class="btn btn-professional btn-add control-add mb-2" id="zoom-community" data-category="Community">
      Community<br><small>Urgent Need</small>
    </button>
    <button class="btn btn-professional btn-add control-add mb-2" id="zoom-business" data-category="Commerce">
      Commerce<br><small>Ideas & Wants</small>
    </button>
    <button class="btn btn-professional btn-add control-add" id="zoom-inner-circle" data-category="Private">
      Private<br><small>Family & Friends</small>
    </button>
  </div>
  <div>
    <h5>View</h5>
    <button class="btn btn-professional btn-view control-view" id="zoom-community-2" data-category="Community">
      Community Needs
    </button>
    <button class="btn btn-professional btn-view control-view" id="zoom-business-2" data-category="Commerce">
      Business Ideas
    </button>
    <button class="btn btn-professional btn-view control-view" id="zoom-inner-circle-2" data-category="Private">
      Private Interest
    </button>
  </div>
</div>

<!-- Offcanvas for Mobile Add Controls -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileAdd" aria-labelledby="mobileAddLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileAddLabel">Add Need/Idea</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-4">
      <button class="btn btn-professional btn-add control-add mb-2" id="zoom-community-mobile" data-category="Community" data-bs-dismiss="offcanvas">
        Community<br><small>Urgent Need</small>
      </button>
      <button class="btn btn-professional btn-add control-add mb-2" id="zoom-business-mobile" data-category="Commerce" data-bs-dismiss="offcanvas">
        Commerce<br><small>Ideas & Wants</small>
      </button>
      <button class="btn btn-professional btn-add control-add mb-2" id="zoom-inner-circle-mobile" data-category="Private" data-bs-dismiss="offcanvas">
        Private<br><small>Family & Friends</small>
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas for Mobile View Controls -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileView" aria-labelledby="mobileViewLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileViewLabel">View Need/Idea</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div>
      <button class="btn btn-professional btn-view control-view mb-2" id="zoom-community-2-mobile" data-category="Community" data-bs-dismiss="offcanvas">
        Community Needs
      </button>
      <button class="btn btn-professional btn-view control-view mb-2" id="zoom-business-2-mobile" data-category="Commerce" data-bs-dismiss="offcanvas">
        Business Ideas
      </button>
      <button class="btn btn-professional btn-view control-view mb-2" id="zoom-inner-circle-2-mobile" data-category="Private" data-bs-dismiss="offcanvas">
        Private Interest
      </button>
    </div>
  </div>
</div>

<!-- Mobile Controls Toggle Buttons -->
<div class="d-lg-none text-center my-3">
  <button class="btn btn-primary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileAdd" aria-controls="mobileAdd">
    Add Need/Idea
  </button>
  <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileView" aria-controls="mobileView">
    View Need/Idea
  </button>
</div>

<!-- Map Container -->
<div class="container my-4">
  <div id="map"></div>
</div>

<!-- About Section -->
<section id="about-section" class="container">
  <div class="text-center mb-4">
    <h2 class="professional-heading" style="font-size: 2rem;">Empowering Communities</h2>
    <p class="lead">A Journey of Innovation and Transformation</p>
  </div>
  <div class="mx-auto" style="max-width: 800px;">
    <p class="lead"><strong>Blumaps</strong> is a pioneering social impact platform and community resource network managed by <strong>BluNotions (Pty) Ltd</strong> and supported by the <strong>AWS Rapid Ramp Program</strong>.</p>
    <p class="lead">Our state-of-the-art interactive web application redefines community engagement by mapping urgent needs, breakthrough ideas, and transformative projects in real time, effectively bridging the gap between resources and those in need.</p>
    <p class="lead">You can help and donate directly to individuals of your choice. When you help, your support comes via direct email communication, providing personal guidance and assistance. When you donate, your financial contribution is applied directly to those in need, ensuring a tangible impact.</p>
    <p class="lead">Additionally, as you contribute, your status increases‚Äîearning you recognition and valuable NFTs that highlight your social impact.</p>
    <p class="lead">Join us in driving innovation, uplifting communities, and creating lasting change.</p>
    <p class="lead"><strong>Donate today and be part of the change.</strong></p>
  </div>
</section>


</section>

<!-- Donation Modal for Support BluMaps (Centralized Donation) -->
<div class="modal fade" id="donationModal" tabindex="-1" aria-labelledby="donationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: #1a1a1a; color: #fff;">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="donationModalLabel">Support BluMaps </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Choose your preferred donation method:</p>
        <div class="d-grid gap-3">
          <!-- PayPal Donation Link (Organization's) -->
          <a href="https://www.paypal.com/ncp/payment/2BNNA4BYFW8PN" target="_blank" class="btn btn-primary">
            Donate with PayPal
          </a>
          <!-- Crypto Donate Button -->
          <a href="https://commerce.coinbase.com/checkout/YOUR_COINBASE_CHECKOUT_ID" target="_blank" class="btn btn-warning">
            Donate with Crypto
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Donation Modal for Support Donee (Direct Donation to Donee) -->
<div class="modal fade" id="donationDoneeModal" tabindex="-1" aria-labelledby="donationDoneeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: #1a1a1a; color: #fff;">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="donationDoneeModalLabel">Support Donee</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Choose your preferred donation method:</p>
        <div class="d-grid gap-3">
          <!-- The PayPal link here will be dynamically updated -->
          <a href="" target="_blank" class="btn btn-primary paypal-link">
            Donate with PayPal
          </a>
          <!-- Crypto Donate Button -->
          <a href="https://commerce.coinbase.com/checkout/YOUR_COINBASE_CHECKOUT_ID" target="_blank" class="btn btn-warning">
            Donate with Crypto
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fixed Donate Button for Support BluMaps -->
<div style="position: fixed; bottom: 20px; left: 20px; z-index: 1200;">
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#donationModal">Support BluNotions</button>
</div>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsentBanner">
  This website uses cookies to enhance your experience.
  <a href="/privacy-policy" class="text-decoration-underline text-light">Learn more</a>
  <button id="accept-cookies" class="btn btn-primary btn-sm">Accept</button>
</div>

<!-- Mapbox and Bootstrap JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Web3Auth -->
<script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@latest/dist/web3auth.umd.min.js"></script>

<script>
  // ================================================
  // Authentication System (Local Points & Stars)
  // ================================================
  class AuthSystem {
    constructor() {
      this.currentUser = null;
      this.users = JSON.parse(localStorage.getItem('users') || '{}');
    }
    login(phoneOrEmail, password) {
      const user = this.users[phoneOrEmail];
      if (!user || user.password !== password) {
        return { success: false, message: 'Invalid credentials' };
      }
      this.currentUser = phoneOrEmail;
      return { success: true, user: phoneOrEmail, stars: user.stars };
    }
    register(phoneOrEmail, password) {
      if (this.users[phoneOrEmail]) {
        return { success: false, message: 'User already exists' };
      }
      this.users[phoneOrEmail] = { password, points: 0, stars: 0 };
      localStorage.setItem('users', JSON.stringify(this.users));
      return { success: true, user: phoneOrEmail, stars: 0 };
    }
    logout() { this.currentUser = null; }
    updateUserPoints(phoneOrEmail, points) {
      if (!this.users[phoneOrEmail]) return;
      let user = this.users[phoneOrEmail];
      user.points += points;
      while (user.points >= 10) {
        user.stars += 1;
        user.points -= 10;
      }
      this.users[phoneOrEmail] = user;
      localStorage.setItem('users', JSON.stringify(this.users));
      document.getElementById("userStars").textContent = "‚òÖ".repeat(user.stars);
    }
    getUserStars(phoneOrEmail) {
      return this.users[phoneOrEmail]?.stars || 0;
    }
  }
  const authSystem = new AuthSystem();

  // ================================================
  // Web3Auth Initialization
  // ================================================
  let web3auth;
  async function initWeb3Auth() {
    if (typeof window.Web3auth === "undefined") {
      console.error("‚ùå Web3Auth library not loaded! Check your script tag.");
      alert("Web3Auth is not ready yet. Please refresh the page.");
      return;
    }
    try {
      web3auth = new window.Web3auth.Web3Auth({
        clientId: "YOBHFz0jugozoNYo_RsyPxUN7RN6AjGcjD6BHe2VW0L7eySoWRFIJD5RY-YyP_AoFiGu1vAJZmk7snW6eQ_2wzoSM",
        chainConfig: { 
          chainNamespace: "eip155",
          chainId: "0x89", // Polygon Mainnet
          rpcTarget: "https://polygon-mainnet.infura.io/v3/b975b16cad1340d0a6edc9afc36e0c4d"
        },
        uiConfig: {
          theme: "dark",
          loginMethodsOrder: ["google", "facebook", "apple"],
        }
      });
      await web3auth.initModal();
      console.log("‚úÖ Web3Auth Initialized");
    } catch (error) {
      console.error("‚ùå Error initializing Web3Auth:", error);
      alert("Failed to initialize Web3Auth. Please try again.");
    }
  }
  window.addEventListener("load", async () => {
    console.log("üì¢ Page Loaded. Initializing Web3Auth...");
    await initWeb3Auth();
  });

  // ================================================
  // Handle "Log in with Google" using Web3Auth
  // ================================================
  document.getElementById("googleLoginBtn").addEventListener("click", async function() {
    if (!web3auth) {
      console.error("‚ùå Web3Auth is not initialized yet.");
      alert("Web3Auth is not ready yet. Please try again in a moment.");
      return;
    }
    try {
      const provider = await web3auth.connect();
      console.log("‚úÖ Web3Auth provider:", provider);
      authSystem.currentUser = "web3authUser";
      document.getElementById('auth-link').textContent = 'Log Out';
      document.getElementById('brandName').textContent = "Web3Auth User";
      document.getElementById('statusNav').classList.remove('d-none');
      bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    } catch (error) {
      console.error("‚ùå Error logging in with Web3Auth:", error);
      alert("Login failed. Please try again.");
    }
  });

  // ================================================
  // Handle Local Login Form
  // ================================================
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const phoneOrEmail = document.getElementById('loginPhoneOrEmail').value;
    const password = document.getElementById('loginPassword').value;
    if (!authSystem || typeof authSystem.login !== "function") {
      console.error("‚ùå authSystem is not defined or not working.");
      alert("Authentication system is unavailable.");
      return;
    }
    const result = authSystem.login(phoneOrEmail, password);
    if (result.success) {
      document.getElementById('auth-link').textContent = 'Log Out';
      document.getElementById('brandName').textContent = result.user;
      document.getElementById('statusNav').classList.remove('d-none');
      document.getElementById("userStars").textContent = "‚òÖ".repeat(result.stars);
      bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    } else {
      alert(result.message);
    }
  });

  // ================================================
  // Logout Handling
  // ================================================
  document.getElementById('auth-link').addEventListener('click', async function(e) {
    if (authSystem.currentUser === null || authSystem.currentUser === "web3authUser") {
      e.preventDefault();
      try {
        if (web3auth) {
          await web3auth.logout();
          console.log("‚úÖ Web3Auth Logged Out");
        }
        authSystem.logout();
        document.getElementById('auth-link').textContent = 'Log In';
        document.getElementById('brandName').textContent = 'Blumaps';
        document.getElementById('statusNav').classList.add('d-none');
      } catch (error) {
        console.error("‚ùå Error during Web3Auth logout:", error);
        alert("Logout failed. Please try again.");
      }
    }
  });

  // ================================================
  // Mapbox Initialization with Fly-To Animation
  // ================================================
  mapboxgl.accessToken = 'pk.eyJ1IjoibW9ybmVncmVlbiIsImEiOiJjamJsNWJtc3oxbDl6MzFvYnpoeHNucHNkIn0.F8OjEDmrkseIRVMOt32Fcw';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mornegreen/cm6kon7vb00l001saaltfal2i',
    center: [0, 20],
    zoom: 1
  });
  map.addControl(new mapboxgl.NavigationControl());
  map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true
  }));
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        var userLocation = [position.coords.longitude, position.coords.latitude];
        map.flyTo({
          center: userLocation,
          zoom: 15,
          speed: 1.8,
          curve: 1.42,
          easing: function(t) { return t; }
        });
      },
      function(error) {
        console.error('Error getting location:', error);
      }
    );
  }

  // ================================================
  // Marker and Control Functionality
  // ================================================
  let canAddMarker = false;
  let markers = [];

  // Modified to accept a "payLink" parameter for donee-specific payment details
  function placeMarker(location, category, title = "Unnamed", description = "No details available.", email = "Not provided", phone = "Not provided", payLink = "") {
    let donateButtonHtml = "";
    if (!authSystem.currentUser || authSystem.currentUser !== email) {
      // Include the donee payment link as a data attribute
      donateButtonHtml = `<button class="btn btn-success btn-sm popup-donate" data-email="${email}" data-phone="${phone}" data-paylink="${payLink}">Donate</button>`;
    }
    const popupContent = `
      <strong style="color: black;">${title}</strong>
      <p style="color: black;">${description}</p>
      <div style="margin-top: 10px;">
        <button class="btn btn-primary btn-sm popup-help" data-email="${email}" data-phone="${phone}">Help</button>
        ${donateButtonHtml}
      </div>
    `;
    const marker = new mapboxgl.Marker().setLngLat(location).addTo(map);
    markers.push(marker);
    marker.getElement().dataset.category = category;
    const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent).setLngLat(location);
    marker.getElement().addEventListener('click', () => { popup.toggle(); });
    marker.setPopup(popup);
  }

  function clearMarkers() {
    markers.forEach(marker => marker.remove());
    markers = [];
  }

  function showTapMessage(message, duration = 3000) {
    const tapMessage = document.getElementById('tapMessage');
    tapMessage.textContent = message;
    tapMessage.style.display = "block";
    setTimeout(() => { tapMessage.style.display = "none"; }, duration);
  }

  // Help button: Opens email client (no points updated)
  document.addEventListener('click', function(e) {
    if (e.target && e.target.matches('.popup-help')) {
      e.stopPropagation();
      if (!authSystem.currentUser) {
        new bootstrap.Modal(document.getElementById('authModal')).show();
        showTapMessage("Please log in to help.", 3000);
        e.preventDefault();
        return;
      }
      const doneeEmail = e.target.getAttribute("data-email");
      const subject = encodeURIComponent("Assistance Inquiry from BluMaps");
      const body = encodeURIComponent("Hi, I saw your need on BluMaps and would like to offer help. Please contact me for further details.");
      window.open(`mailto:${doneeEmail}?subject=${subject}&body=${body}`, '_blank');
      showTapMessage("Your help inquiry email has been prepared. Please check your email.", 3000);
    }
  });

  // Donate button: Updates donation points and opens the Support Donee modal (with donee's payment details)
  document.addEventListener('click', function(e) {
    if (e.target && e.target.matches('.popup-donate')) {
      e.stopPropagation();
      if (!authSystem.currentUser) {
        new bootstrap.Modal(document.getElementById('authModal')).show();
        showTapMessage("Please log in to donate.", 3000);
        e.preventDefault();
        return;
      }
      authSystem.updateUserPoints(authSystem.currentUser, 1);
      // Retrieve donee's payment link from data attribute
      const doneePayLink = e.target.getAttribute("data-paylink");
      // Update the donationDoneeModal's PayPal link dynamically
      const paypalLinkAnchor = document.querySelector("#donationDoneeModal a.paypal-link");
      if (doneePayLink && doneePayLink.trim() !== "") {
         paypalLinkAnchor.setAttribute("href", doneePayLink);
      } else {
         paypalLinkAnchor.setAttribute("href", "https://default-donee-link.example.com");
      }
      new bootstrap.Modal(document.getElementById('donationDoneeModal')).show();
      showTapMessage("Please review the donation options.", 3000);
    }
  });

  // Controls to add new markers.
  document.querySelectorAll('.control-add').forEach(button => {
    button.addEventListener('click', function() {
      if (!authSystem.currentUser) {
        new bootstrap.Modal(document.getElementById('authModal')).show();
        showTapMessage("Please log in to add a marker.", 3000);
        return;
      }
      const category = this.getAttribute('data-category');
      document.getElementById('category').value = category;
      canAddMarker = true;
      const tapMessage = document.getElementById('tapMessage');
      tapMessage.textContent = "Tap on the map to add a marker";
      tapMessage.style.display = "block";
      const messageTimeout = setTimeout(() => { tapMessage.style.display = "none"; }, 4000);
      map.once('click', function(event) {
        if (canAddMarker) {
          const coordinates = event.lngLat;
          document.getElementById('latitude').value = coordinates.lat;
          document.getElementById('longitude').value = coordinates.lng;
          // For demonstration, pass an example donee payment link.
          placeMarker(coordinates, category, "New Need", "No details provided.", "donee@example.com", "1234567890", "https://www.paypal.com/ncp/payment/DONEE_SPECIFIC_LINK");
          let offcanvasAddEl = document.getElementById('mobileAdd');
          let offcanvasViewEl = document.getElementById('mobileView');
          if (offcanvasAddEl && offcanvasAddEl.classList.contains('show')) {
            let offcanvasAdd = bootstrap.Offcanvas.getInstance(offcanvasAddEl);
            offcanvasAdd.hide();
          }
          if (offcanvasViewEl && offcanvasViewEl.classList.contains('show')) {
            let offcanvasView = bootstrap.Offcanvas.getInstance(offcanvasViewEl);
            offcanvasView.hide();
          }
          tapMessage.style.display = "none";
          clearTimeout(messageTimeout);
          new bootstrap.Modal(document.getElementById('dataModal')).show();
        }
      });
    });
  });

  // Controls to view markers.
  document.querySelectorAll('.control-view').forEach(button => {
    button.addEventListener('click', function() {
      canAddMarker = false;
      const category = this.getAttribute('data-category');
      clearMarkers();
      fetch('/get_existing_data/')
        .then(response => response.json())
        .then(data => {
          data.filter(item => item.Category === category).forEach(item => {
            const location = [item.Longitude, item.Latitude];
            // Assume that each item has a "PaymentLink" field for donee donations.
            placeMarker(location, item.Category, item.Name, item.Description, item.Email, item.Phone, item.PaymentLink);
          });
        })
        .catch(error => console.error('Error fetching data:', error));
      let offcanvasAddEl = document.getElementById('mobileAdd');
      let offcanvasViewEl = document.getElementById('mobileView');
      if (offcanvasAddEl && offcanvasAddEl.classList.contains('show')) {
        let offcanvasAdd = bootstrap.Offcanvas.getInstance(offcanvasAddEl);
        offcanvasAdd.hide();
      }
      if (offcanvasViewEl && offcanvasViewEl.classList.contains('show')) {
        let offcanvasView = bootstrap.Offcanvas.getInstance(offcanvasViewEl);
        offcanvasView.hide();
      }
    });
  });

  // ================================================
  // Check Toxicity via Perspective API
  // ================================================
  async function checkToxicity(text) {
    const apiKey = "AIzaSyAYwrzOaH6eIU63Wwz1TcBZodnjvYV0-_k";
    const url = `https://commentanalyzer.googleapis.com/v1alpha1/comments:analyze?key=${apiKey}`;
    const requestBody = {
      comment: { text: text },
      languages: ["en"],
      requestedAttributes: { TOXICITY: {} }
    };
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody)
      });
      if (!response.ok) {
        console.error("Perspective API error:", response.statusText);
        return 0;
      }
      const data = await response.json();
      return data.attributeScores.TOXICITY.summaryScore.value;
    } catch (error) {
      console.error("Error calling Perspective API:", error);
      return 0;
    }
  }

  // Handle Location Form Submission with Toxicity Check
  document.getElementById('locationForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const combinedText = title + " " + description;
    const toxicity = await checkToxicity(combinedText);
    console.log("Toxicity score:", toxicity);
    if (toxicity >= 0.7) {
      alert("Your submission contains inappropriate content. Please revise your text.");
      return;
    }
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const category = document.getElementById('category').value;
    const data = { title, latitude, longitude, description, category };
    fetch('/save_location', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(responseData => {
      console.log('Success:', responseData);
      placeMarker([longitude, latitude], category, title, description);
    })
    .catch(error => console.error('Error:', error));
    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('dataModal'));
    modalInstance.hide();
    this.reset();
  });

  // Get Cookie for CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Cookie Consent
  if (!localStorage.getItem('cookieConsent')) {
    const cookieConsentBanner = document.getElementById('cookieConsentBanner');
    cookieConsentBanner.style.display = 'block';
    document.getElementById('accept-cookies').addEventListener('click', () => {
      localStorage.setItem('cookieConsent', 'true');
      cookieConsentBanner.style.display = 'none';
    });
  }

  // Draggable Functionality for Sidebars
  function makeDraggable(el) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    el.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      el.style.top = (el.offsetTop - pos2) + "px";
      el.style.left = (el.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const leftSidebar = document.querySelector('.sidebar.d-none.d-lg-block');
    if (leftSidebar) { makeDraggable(leftSidebar); }
    const dataScienceSidebar = document.getElementById("dataScienceSidebar");
    makeDraggable(dataScienceSidebar);
  });

  // Show Data Science Sidebar
  document.getElementById("dataScienceBtn").addEventListener("click", function () {
    const sidebar = document.getElementById("dataScienceSidebar");
    sidebar.classList.remove("d-none");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          fetch(`/get_most_urgent_need/?lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
              if (data && data.need) {
                document.getElementById("dataScienceContent").innerHTML = `
                  <strong>${data.need.title}</strong>
                  <p>${data.need.description}</p>
                  <p><strong>Category:</strong> ${data.need.category}</p>
                  <p><strong>Location:</strong> ${data.need.location}</p>
                `;
              } else {
                document.getElementById("dataScienceContent").innerHTML = "<p>No urgent needs found in your area.</p>";
              }
            })
            .catch(error => {
              console.error("Error fetching data:", error);
              document.getElementById("dataScienceContent").innerHTML = "<p>Unable to retrieve data.</p>";
            });
        },
        function (error) {
          console.error("Geolocation error:", error);
          document.getElementById("dataScienceContent").innerHTML = "<p>Could not get location.</p>";
        }
      );
    } else {
      document.getElementById("dataScienceContent").innerHTML = "<p>Geolocation is not supported by your browser.</p>";
    }
  });

  // Close Data Science Sidebar
  document.getElementById("closeDataScience").addEventListener("click", function () {
    document.getElementById("dataScienceSidebar").classList.add("d-none");
  });

  // Scroll Up / Scroll Down Buttons
  const scrollUpBtn = document.createElement('button');
  scrollUpBtn.id = 'scrollUpBtn';
  scrollUpBtn.className = 'scroll-btn';
  scrollUpBtn.textContent = '‚ñ≤';
  document.body.appendChild(scrollUpBtn);
  const scrollDownBtn = document.createElement('button');
  scrollDownBtn.id = 'scrollDownBtn';
  scrollDownBtn.className = 'scroll-btn';
  scrollDownBtn.textContent = '‚ñº';
  document.body.appendChild(scrollDownBtn);
  scrollUpBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  scrollDownBtn.addEventListener('click', () => {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  });
</script>

<!-- Banner Section -->
<div class="banner">
  <img src="{% static 'awslogo.png' %}" alt="AWS Logo" class="banner-logo">
  <img src="{% static 'BluNotionLogo.png' %}" alt="BluNotion Logo" class="banner-logo">
  <img src="{% static 'github.png' %}" alt="github Logo" class="banner-logo">
  <img src="{% static 'linuxlogo2.png' %}" alt="linuxlogo2 Logo" class="banner-logo">
  <img src="{% static 'nftlogo.png' %}" alt="nftlogo Logo" class="banner-logo">
  <img src="{% static 'web3.png' %}" alt="web3 Logo" class="banner-logo">
  <img src="{% static 'cryptlogo.png' %}" alt="cryptlogo Logo" class="banner-logo">
  <img src="{% static 'python.png' %}" alt="python" class="banner-logo">
</div>

<div id="tapMessage">Tap on map to add</div>

</body>
</html>
